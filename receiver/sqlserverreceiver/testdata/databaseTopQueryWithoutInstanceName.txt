
DECLARE @lookbackTime INT = -60;
DECLARE @topNValue INT = 1000;
SELECT TOP(@topNValue)
	REPLACE(@@SERVERNAME,'\',':') AS [sql_instance],
	HOST_NAME() AS [computer_name],
	CONVERT(VARCHAR(1000), MAX(qs.plan_handle), 2) AS query_plan_handle,
	CONVERT(VARCHAR(1000), qs.query_hash, 2) AS query_hash,
	CONVERT(VARCHAR(1000), qs.query_plan_hash, 2) AS query_plan_hash,
	SUM(qs.execution_count) AS execution_count,
	SUM(qs.total_elapsed_time) AS total_elapsed_time,
	SUM(qs.total_worker_time) AS total_worker_time,
	SUM(qs.total_logical_reads) AS total_logical_reads,
	SUM(qs.total_physical_reads) AS total_physical_reads,
	SUM(qs.total_logical_writes) AS total_logical_writes,
	SUM(qs.total_rows) AS total_rows,
	SUM(qs.total_grant_kb) as total_grant_kb
FROM sys.dm_exec_query_stats AS qs
WHERE qs.last_execution_time BETWEEN DATEADD(SECOND, @lookbackTime, GETDATE()) AND GETDATE() 
GROUP BY
	qs.query_hash,
	qs.query_plan_hash
