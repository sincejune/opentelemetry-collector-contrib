
SELECT
SUBSTRING(st.text, (stats.statement_start_offset / 2) + 1,
		 ((CASE stats.statement_end_offset
			   WHEN -1 THEN DATALENGTH(st.text)
			   ELSE stats.statement_end_offset END - stats.statement_start_offset) / 2) + 1) AS query_text,
ISNULL(qp.query_plan, '') AS query_plan
FROM sys.dm_exec_query_stats AS qs
INNER JOIN sys.dm_exec_query_stats AS stats on qs.plan_handle = stats.plan_handle and qs.query_hash = stats.query_hash and qs.query_plan_hash = stats.query_plan_hash
CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) AS qp
CROSS APPLY sys.dm_exec_sql_text(qs.plan_handle) AS st
WHERE qs.query_hash = 0x111
AND qs.query_plan_hash = 0x1111
AND qs.plan_handle = 0x11111
